generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─── ENUMS ──────────────────────────────────────────────

enum UserRole {
  CUSTOMER
  ADMIN
  SUPER_ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// ─── USER & AUTH ────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  role          UserRole  @default(CUSTOMER)
  emailVerified Boolean   @default(false)
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  addresses     Address[]
  orders        Order[]
  reviews       Review[]
  questions     ProductQuestion[]
  answers       ProductAnswer[]
  wishlist      WishlistItem[]
  cart          CartItem[]
  auditLogs     AuditLog[]

  @@index([email])
}

model Address {
  id          String  @id @default(cuid())
  userId      String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  firstName   String
  lastName    String
  phone       String
  city        String
  district    String
  address     String
  postalCode  String?
  isDefault   Boolean @default(false)

  orders      Order[]

  @@index([userId])
}

// ─── CATALOG ────────────────────────────────────────────

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  seoSlug     String?    @unique
  description String?
  icon        String?
  image       String?
  parentId    String?
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryTree")
  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  seoTitle    String?
  seoDesc     String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  products    ProductCategory[]

  @@index([parentId])
  @@index([slug])
  @@index([seoSlug])
}

model Brand {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  logo        String?
  description String?
  website     String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@index([slug])
}

model Product {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  sku             String    @unique
  description     String?
  shortDesc       String?
  price           Decimal   @db.Decimal(10, 2)
  compareAtPrice  Decimal?  @db.Decimal(10, 2)
  costPrice       Decimal?  @db.Decimal(10, 2)
  currency        String    @default("TRY")
  brandId         String?
  brand           Brand?    @relation(fields: [brandId], references: [id])
  inStock         Boolean   @default(true)
  stockCount      Int       @default(0)
  lowStockThreshold Int     @default(5)
  weight          Decimal?  @db.Decimal(8, 2)
  badge           String?
  badgeColor      String?
  isActive        Boolean   @default(true)
  isFeatured      Boolean   @default(false)
  isNewArrival    Boolean   @default(false)
  viewCount       Int       @default(0)
  seoTitle        String?
  seoDesc         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  categories      ProductCategory[]
  images          ProductImage[]
  attributes      ProductAttribute[]
  reviews         Review[]
  questions       ProductQuestion[]
  orderItems      OrderItem[]
  wishlistItems   WishlistItem[]
  cartItems       CartItem[]
  bundleItems     BundleItem[]
  downloads       ProductDownload[]

  @@index([slug])
  @@index([sku])
  @@index([brandId])
  @@index([isActive, isFeatured])
}

model ProductCategory {
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@index([categoryId])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  alt       String?
  sortOrder Int     @default(0)

  @@index([productId])
}

model ProductAttribute {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  key       String
  value     String

  @@index([productId])
  @@index([key])
}

model ProductDownload {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  title     String
  fileUrl   String
  fileType  String
  fileSize  String?

  @@index([productId])
}

// ─── BUNDLES ────────────────────────────────────────────

model Bundle {
  id          String       @id @default(cuid())
  name        String
  slug        String       @unique
  rootSlug    String?      @unique
  description String?
  image       String?
  discount    Decimal?     @db.Decimal(5, 2)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  items       BundleItem[]

  @@index([slug])
  @@index([rootSlug])
}

model BundleItem {
  id        String  @id @default(cuid())
  bundleId  String
  bundle    Bundle  @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int     @default(1)

  @@index([bundleId])
}

// ─── REVIEWS & QA ───────────────────────────────────────

model Review {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  rating    Int
  title     String?
  comment   String?
  isApproved Boolean @default(false)
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([userId])
}

model ProductQuestion {
  id        String          @id @default(cuid())
  productId String
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId    String
  user      User            @relation(fields: [userId], references: [id])
  question  String
  isPublic  Boolean         @default(true)
  createdAt DateTime        @default(now())

  answers   ProductAnswer[]

  @@index([productId])
}

model ProductAnswer {
  id         String          @id @default(cuid())
  questionId String
  question   ProductQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  userId     String
  user       User            @relation(fields: [userId], references: [id])
  answer     String
  createdAt  DateTime        @default(now())

  @@index([questionId])
}

// ─── ORDERS ─────────────────────────────────────────────

model Order {
  id             String        @id @default(cuid())
  orderNumber    String        @unique
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  addressId      String
  address        Address       @relation(fields: [addressId], references: [id])
  status         OrderStatus   @default(PENDING)
  paymentStatus  PaymentStatus @default(PENDING)
  subtotal       Decimal       @db.Decimal(10, 2)
  shippingCost   Decimal       @default(0) @db.Decimal(10, 2)
  discount       Decimal       @default(0) @db.Decimal(10, 2)
  total          Decimal       @db.Decimal(10, 2)
  currency       String        @default("TRY")
  couponCode     String?
  notes          String?
  trackingNumber String?
  trackingUrl    String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  items          OrderItem[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  name      String
  sku       String
  price     Decimal @db.Decimal(10, 2)
  quantity  Int
  total     Decimal @db.Decimal(10, 2)

  @@index([orderId])
}

// ─── CART & WISHLIST ────────────────────────────────────

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int      @default(1)
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
}

// ─── COUPONS ────────────────────────────────────────────

model Coupon {
  id             String   @id @default(cuid())
  code           String   @unique
  description    String?
  discountType   String   @default("percentage") // percentage | fixed
  discountValue  Decimal  @db.Decimal(10, 2)
  minOrderAmount Decimal? @db.Decimal(10, 2)
  maxUses        Int?
  usedCount      Int      @default(0)
  isActive       Boolean  @default(true)
  startsAt       DateTime?
  expiresAt      DateTime?
  createdAt      DateTime @default(now())

  @@index([code])
}

// ─── BLOG ───────────────────────────────────────────────

model BlogCategory {
  id        String     @id @default(cuid())
  name      String
  slug      String     @unique
  rootSlug  String?    @unique
  sortOrder Int        @default(0)
  createdAt DateTime   @default(now())

  posts     BlogPost[]

  @@index([slug])
  @@index([rootSlug])
}

model BlogPost {
  id          String       @id @default(cuid())
  title       String
  slug        String       @unique
  excerpt     String?
  content     String?
  image       String?
  categoryId  String
  category    BlogCategory @relation(fields: [categoryId], references: [id])
  authorName  String?
  isPublished Boolean      @default(false)
  publishedAt DateTime?
  seoTitle    String?
  seoDesc     String?
  viewCount   Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([slug])
  @@index([categoryId])
  @@index([isPublished])
}

// ─── STATIC PAGES ───────────────────────────────────────

model StaticPage {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  content   String?
  seoTitle  String?
  seoDesc   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

// ─── FILE LIBRARY ───────────────────────────────────────

model FileLibrary {
  id        String   @id @default(cuid())
  title     String
  category  String
  fileUrl   String
  fileType  String
  fileSize  String?
  icon      String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([category])
}

// ─── SITE SETTINGS ──────────────────────────────────────

model SiteSettings {
  id                 String  @id @default("default")
  siteName           String  @default("CNC Otomasyon")
  siteDescription    String?
  phone              String?
  whatsapp           String?
  email              String?
  address            String?
  workingHours       String?
  facebookUrl        String?
  instagramUrl       String?
  linkedinUrl        String?
  youtubeUrl         String?
  dosyaMerkeziSlug   String  @default("dosya-merkezi")
  defaultCurrency    String  @default("TRY")
  logoUrl            String?
  faviconUrl         String?
}

// ─── AUDIT LOG ──────────────────────────────────────────

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  entity    String
  entityId  String?
  details   String?
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}
