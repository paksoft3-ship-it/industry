generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String            @id @default(cuid())
  email         String            @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  role          UserRole          @default(CUSTOMER)
  emailVerified Boolean           @default(false)
  avatar        String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  addresses     Address[]
  auditLogs     AuditLog[]
  cart          CartItem[]
  orders        Order[]
  answers       ProductAnswer[]
  questions     ProductQuestion[]
  reviews       Review[]
  wishlist      WishlistItem[]

  @@index([email])
}

model Address {
  id         String  @id @default(cuid())
  userId     String
  title      String
  firstName  String
  lastName   String
  phone      String
  city       String
  district   String
  address    String
  postalCode String?
  isDefault  Boolean @default(false)
  user       User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders     Order[]

  @@index([userId])
}

model Category {
  id              String            @id @default(cuid())
  name            String
  slug            String            @unique
  seoSlug         String?           @unique
  description     String?
  icon            String?
  image           String?
  parentId        String?
  order           Int               @default(0)
  isActive        Boolean           @default(true)
  seoTitle        String?
  seoDesc         String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  parent          Category?         @relation("CategoryTree", fields: [parentId], references: [id])
  children        Category[]        @relation("CategoryTree")
  categoryFilters CategoryFilter[]
  products        ProductCategory[]

  @@index([parentId])
  @@index([slug])
  @@index([seoSlug])
}

model Brand {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  logo        String?
  description String?
  website     String?
  isActive    Boolean   @default(true)
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@index([slug])
}

model Product {
  id                String                  @id @default(cuid())
  name              String
  slug              String                  @unique
  sku               String                  @unique
  description       String?
  shortDesc         String?
  price             Decimal                 @db.Decimal(10, 2)
  compareAtPrice    Decimal?                @db.Decimal(10, 2)
  costPrice         Decimal?                @db.Decimal(10, 2)
  currency          String                  @default("TRY")
  brandId           String?
  inStock           Boolean                 @default(true)
  stockCount        Int                     @default(0)
  lowStockThreshold Int                     @default(5)
  weight            Decimal?                @db.Decimal(8, 2)
  badge             String?
  badgeColor        String?
  isActive          Boolean                 @default(true)
  isFeatured        Boolean                 @default(false)
  isNewArrival      Boolean                 @default(false)
  viewCount         Int                     @default(0)
  seoTitle          String?
  seoDesc           String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  bundleItems       BundleItem[]
  cartItems         CartItem[]
  orderItems        OrderItem[]
  brand             Brand?                  @relation(fields: [brandId], references: [id])
  attributes        ProductAttribute[]
  attributeValues   ProductAttributeValue[]
  categories        ProductCategory[]
  downloads         ProductDownload[]
  images            ProductImage[]
  questions         ProductQuestion[]
  reviews           Review[]
  wishlistItems     WishlistItem[]

  @@index([slug])
  @@index([sku])
  @@index([brandId])
  @@index([isActive, isFeatured])
}

model ProductCategory {
  productId  String
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@index([categoryId])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  alt       String?
  order     Int     @default(0)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductAttribute {
  id        String  @id @default(cuid())
  productId String
  key       String
  value     String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([key])
}

model ProductDownload {
  id        String  @id @default(cuid())
  productId String
  title     String
  fileUrl   String
  fileType  String
  fileSize  String?
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model AttributeDefinition {
  id              String                  @id @default(cuid())
  key             String                  @unique
  label           String
  type            AttributeType
  unit            String?
  isActive        Boolean                 @default(true)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  options         AttributeOption[]
  categoryFilters CategoryFilter[]
  productValues   ProductAttributeValue[]
}

model AttributeOption {
  id          String              @id @default(cuid())
  attributeId String
  value       String
  order       Int                 @default(0)
  attribute   AttributeDefinition @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([attributeId, value])
  @@index([attributeId, order])
}

model CategoryFilter {
  id           String               @id @default(cuid())
  categoryId   String
  attributeId  String?
  builtinKey   String?
  uiType       FilterUiType
  order        Int                  @default(0)
  isVisible    Boolean              @default(true)
  isInherited  Boolean              @default(true)
  isSearchable Boolean              @default(true)
  attribute    AttributeDefinition? @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  category     Category             @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId, order])
}

model ProductAttributeValue {
  id          String              @id @default(cuid())
  productId   String
  attributeId String
  valueString String?
  valueNumber Float?
  attribute   AttributeDefinition @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  product     Product             @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, attributeId])
  @@index([productId])
  @@index([attributeId])
}

model Bundle {
  id          String       @id @default(cuid())
  name        String
  slug        String       @unique
  rootSlug    String?      @unique
  description String?
  image       String?
  discount    Decimal?     @db.Decimal(5, 2)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  items       BundleItem[]

  @@index([slug])
  @@index([rootSlug])
}

model BundleItem {
  id        String  @id @default(cuid())
  bundleId  String
  productId String
  quantity  Int     @default(1)
  bundle    Bundle  @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])

  @@index([bundleId])
}

model Review {
  id         String   @id @default(cuid())
  productId  String
  userId     String
  rating     Int
  title      String?
  comment    String?
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([userId])
}

model ProductQuestion {
  id        String          @id @default(cuid())
  productId String
  userId    String
  question  String
  isPublic  Boolean         @default(true)
  createdAt DateTime        @default(now())
  answers   ProductAnswer[]
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id])

  @@index([productId])
}

model ProductAnswer {
  id         String          @id @default(cuid())
  questionId String
  userId     String
  answer     String
  createdAt  DateTime        @default(now())
  question   ProductQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id])

  @@index([questionId])
}

model Order {
  id             String        @id @default(cuid())
  orderNumber    String        @unique
  userId         String
  addressId      String
  status         OrderStatus   @default(PENDING)
  paymentStatus  PaymentStatus @default(PENDING)
  subtotal       Decimal       @db.Decimal(10, 2)
  shippingCost   Decimal       @default(0) @db.Decimal(10, 2)
  discount       Decimal       @default(0) @db.Decimal(10, 2)
  total          Decimal       @db.Decimal(10, 2)
  currency       String        @default("TRY")
  couponCode     String?
  notes          String?
  trackingNumber String?
  trackingUrl    String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  address        Address       @relation(fields: [addressId], references: [id])
  user           User          @relation(fields: [userId], references: [id])
  items          OrderItem[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  name      String
  sku       String
  price     Decimal @db.Decimal(10, 2)
  quantity  Int
  total     Decimal @db.Decimal(10, 2)
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])

  @@index([orderId])
}

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
}

model Coupon {
  id             String    @id @default(cuid())
  code           String    @unique
  description    String?
  discountType   String    @default("percentage")
  discountValue  Decimal   @db.Decimal(10, 2)
  minOrderAmount Decimal?  @db.Decimal(10, 2)
  maxUses        Int?
  usedCount      Int       @default(0)
  isActive       Boolean   @default(true)
  startsAt       DateTime?
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())

  @@index([code])
}

model EducationCategory {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  posts     EducationPost[]

  @@index([slug])
}

model EducationPost {
  id            String   @id @default(cuid())
  title         String
  slug          String
  excerpt       String?
  content       String   @db.Text
  coverImageUrl String?
  isPublished   Boolean  @default(false)
  publishedAt   DateTime?

  seoTitle       String?
  seoDescription String?

  categoryId    String
  category      EducationCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([categoryId, slug])
  @@index([categoryId, isPublished, publishedAt])
}

model StaticPage {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  content   String?
  seoTitle  String?
  seoDesc   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

model BlogCategory {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  posts     BlogPost[]

  @@index([slug])
}

model BlogPost {
  id            String   @id @default(cuid())
  title         String
  slug          String
  excerpt       String?
  content       String   @db.Text
  coverImageUrl String?
  isPublished   Boolean  @default(false)
  publishedAt   DateTime?

  seoTitle       String?
  seoDescription String?

  categoryId    String
  category      BlogCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([categoryId, slug])
  @@index([categoryId, isPublished, publishedAt])
}

model FileLibrary {
  id        String   @id @default(cuid())
  title     String
  category  String
  fileUrl   String
  fileType  String
  fileSize  String?
  icon      String?
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([category])
}

model SiteSettings {
  id               String  @id @default("default")
  siteName         String  @default("CNC Otomasyon")
  siteDescription  String?
  phone            String?
  whatsapp         String?
  email            String?
  address          String?
  workingHours     String?
  facebookUrl      String?
  instagramUrl     String?
  linkedinUrl      String?
  youtubeUrl       String?
  dosyaMerkeziSlug String  @default("dosya-merkezi")
  defaultCurrency  String  @default("TRY")
  logoUrl          String?
  faviconUrl       String?
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  details   String?
  ipAddress String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

enum UserRole {
  CUSTOMER
  ADMIN
  SUPER_ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum AttributeType {
  ENUM
  NUMBER
  TEXT
}

enum FilterUiType {
  CHECKBOX
  RADIO
  RANGE
}
